<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../lunr-js/lunr-js.html">
<!--
[![js-standard-style](https://img.shields.io/badge/code%20style-standard-brightgreen.svg?style=flat)](http://standardjs.com/)

`<html-edit>` help you edit html.
@demo demo.html
-->

<dom-module id="html-edit">
  <template>
    <lunr-js data="{{suggestedTags}}" search="{{filter}}" output="{{ac}}"></lunr-js>
    <div>
      <h3>{{label}}</h3>
      <textarea rows="9" style="width:100%" on-blur="updateFilter" on-keypress="takekey" on-keydown="keydown"  label="{{label}}" value="{{value::input}}"></textarea>
      <select style="width:100%"  on-blur="addTag" multiple>
        <template is="dom-repeat" items="{{ac}}">
          <option value="{{item.code}}" title="{{item.code}}" move="{{item.move}}">{{item.tag}}</option>
        </template>
      </select>
    </div>
    <template is="dom-if" if="{{log}}">{{chrInToTab}}</template>
  </template>
</dom-module>
<script>
var tabStops = []
var onTab = false

function TextEvent (editor, start, end, text, move) {
  var fromArray = null
  var select = 0
  if (start === end) {
    start = editor.selectionStart
    end = editor.selectionEnd
  }
  var e = document.createEvent('TextEvent')
  e.initTextEvent('textInput', true, true, null, text, 9, 'en-US')
  editor.focus()
  editor.setSelectionRange(start, end)
  editor.dispatchEvent(e)
  if (Array.isArray(move)) {
    fromArray = move.shift()
    tabStops = move
  }
  if (Array.isArray(fromArray)) {
    move = (fromArray[0]) * 1
    select = (fromArray[1]) * 1
  } else if ((fromArray) * 1 > 0) {
    move = fromArray
  }
  var moveTo = (start * 1) + move
  editor.setSelectionRange(moveTo, moveTo + select)
}

// names of known key codes (0-255)
var keyboardMap = ['', '', '', 'CANCEL', '', '', 'HELP', '', 'BACK_SPACE', 'TAB', '', '', 'CLEAR', 'ENTER', 'RETURN', '', 'SHIFT', 'CONTROL', 'ALT', 'PAUSE', 'CAPS_LOCK', 'KANA', 'EISU', 'JUNJA', 'FINAL', 'HANJA', '', 'ESCAPE', 'CONVERT', 'NONCONVERT', 'ACCEPT', 'MODECHANGE', 'SPACE', 'PAGE_UP', 'PAGE_DOWN', 'END', 'HOME', 'LEFT', 'UP', 'RIGHT', 'DOWN', 'SELECT', 'PRINT', 'EXECUTE', 'PRINTSCREEN', 'INSERT', 'DELETE', '', '0', '1', '2', '3', '4', '5', '6', '7', '8', '9', 'COLON', 'SEMICOLON', 'LESS_THAN', 'EQUALS', 'GREATER_THAN', 'QUESTION_MARK', 'AT', 'A', 'B', 'C', 'D', 'E', 'F', 'G', 'H', 'I', 'J', 'K', 'L', 'M', 'N', 'O', 'P', 'Q', 'R', 'S', 'T', 'U', 'V', 'W', 'X', 'Y', 'Z', 'WIN', '', 'CONTEXT_MENU', '', 'SLEEP', 'NUMPAD0', 'NUMPAD1', 'NUMPAD2', 'NUMPAD3', 'NUMPAD4', 'NUMPAD5', 'NUMPAD6', 'NUMPAD7', 'NUMPAD8', 'NUMPAD9', 'MULTIPLY', 'ADD', 'SEPARATOR', 'SUBTRACT', 'DECIMAL', 'DIVIDE', 'F1', 'F2', 'F3', 'F4', 'F5', 'F6', 'F7', 'F8', 'F9', 'F10', 'F11', 'F12', 'F13', 'F14', 'F15', 'F16', 'F17', 'F18', 'F19', 'F20', 'F21', 'F22', 'F23', 'F24', '', '', '', '', '', '', '', '', 'NUM_LOCK', 'SCROLL_LOCK', 'WIN_OEM_FJ_JISHO', 'WIN_OEM_FJ_MASSHOU', 'WIN_OEM_FJ_TOUROKU', 'WIN_OEM_FJ_LOYA', 'WIN_OEM_FJ_ROYA', '', '', '', '', '', '', '', '', '', 'CIRCUMFLEX', 'EXCLAMATION', 'DOUBLE_QUOTE', 'HASH', 'DOLLAR', 'PERCENT', 'AMPERSAND', 'UNDERSCORE', 'OPEN_PAREN', 'CLOSE_PAREN', 'ASTERISK', 'PLUS', 'PIPE', 'HYPHEN_MINUS', 'OPEN_CURLY_BRACKET', 'CLOSE_CURLY_BRACKET', 'TILDE', '', '', '', '', 'VOLUME_MUTE', 'VOLUME_DOWN', 'VOLUME_UP', '', '', 'SEMICOLON', 'EQUALS', 'COMMA', 'MINUS', 'PERIOD', 'SLASH', 'BACK_QUOTE', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', 'OPEN_BRACKET', 'BACK_SLASH', 'CLOSE_BRACKET', 'QUOTE', '', 'META', 'ALTGR', '', 'WIN_ICO_HELP', 'WIN_ICO_00', '', 'WIN_ICO_CLEAR', '', '', 'WIN_OEM_RESET', 'WIN_OEM_JUMP', 'WIN_OEM_PA1', 'WIN_OEM_PA2', 'WIN_OEM_PA3', 'WIN_OEM_WSCTRL', 'WIN_OEM_CUSEL', 'WIN_OEM_ATTN', 'WIN_OEM_FINISH', 'WIN_OEM_COPY', 'WIN_OEM_AUTO', 'WIN_OEM_ENLW', 'WIN_OEM_BACKTAB', 'ATTN', 'CRSEL', 'EXSEL', 'EREOF', 'PLAY', 'ZOOM', '', 'PA1', 'WIN_OEM_CLEAR', '']
var Polymer
Polymer({
  is: 'html-edit',
  properties: {
    value: {type: String, notify: true},
    label: String,
    code: {type: Boolean, value: false},
    suggestedTags: {computed: '_getSuggestedTags(tags)'},
    filter: {value: ''},
    /*  `tags` is a Array of Objects
     *  Objects
     *    `tag`  the only one needed
     *
     *    `code` the snippets
     *
     */
    tags: {
      value: [
        {code: ['<template is="dom-if" if="{{', 'test', '}}">\n  ', '', '\n</template>'], tag: 'dom-if'},
        {code: ['<template is="dom-repeat" items="{{', 'items', '}}">\n  ', '', '\n</template>'], tag: 'dom-repeat'},
        {code: ["<paper-input label='", 'label', "' value='{{", 'text', "}}'></paper-input>"], tag: 'paper-input'},
        {
          tag: 'dom-else',
          code: ['<template is="dom-if" if="{{', 'test', '}}">\n  ', 'Stuff', '\n  <template is="dom-else">\n    ', 'More stuff', '\n  </template>\n</template>']
        },
        {tag: 'h1'}, {tag: 'h2'}, {tag: 'h3'}, {tag: 'h4'}, {tag: 'h5'}, {tag: 'h6'}, {tag: 'p'}, {tag: 'i'},
        {code: ['<a href="', 'https://github.com', '" title="', 'github', '">', 'link test on page', '</a>'], tag: 'a'},
        {code: ['\n<ul>\n  <li>', '', '</li>\n</ul>\n'], tag: 'ul', onTab: function (c) {}},
        {tag: 'blockquote'},
        {code: ['\n<hr />\n'], tag: 'hr'},
        {code: ['<img src="', '', '" title="', '', '" />\n'], tag: 'img'},
        {tag: 'div'},
        {tag: 'account-summaries-import'},
        {tag: 'accounting-element'},
        {tag: 'accounting-import'},
        {tag: 'all-imports'},
        {tag: 'animation-tag'},
        {tag: 'app-globals'},
        {tag: 'app-router'},
        {tag: 'av-icons'},
        {tag: 'blockies-import'},
        {tag: 'iron-a11y-announcer'},
        {tag: 'iron-a11y-keys-behavior'},
        {tag: 'iron-a11y-keys'},
        {tag: 'commits-element'},
        {tag: 'commonmark-editor'},
        {tag: 'communication-icons'},
        {tag: 'communication-icons'},
        {tag: 'cosmoz-page-route'},
        {tag: 'cosmoz-page-router'},
        {tag: 'date-input'},
        {tag: 'date-validator'},
        {tag: 'demo-element'},
        {tag: 'demo-pages'},
        {tag: 'detect-import-node-bug'},
        {tag: 'device-icons'},
        {tag: 'device-icons'},
        {tag: 'edit-in-jsbin'},
        {tag: 'editor-icons'},
        {tag: 'editor-icons'},
        {tag: 'excess-route'},
        {tag: 'excess-route-manager'},
        {tag: 'excess-router'},
        {tag: 'excess-router-config'},
        {tag: 'firebase-auth'},
        {tag: 'firebase-collection'},
        {tag: 'firebase-document'},
        {tag: 'firebase-query-behavior'},
        {tag: 'flip-clock'},
        {tag: 'function-list-input'},
        {tag: 'geo-hash-data'},
        {tag: 'geohash-js'},
        {tag: 'get-hash'},
        {tag: 'github-issues'},
        {tag: 'gold-cc-cvc-input'},
        {tag: 'gold-cc-expiration-input'},
        {tag: 'gold-cc-input'},
        {tag: 'gold-email-input'},
        {tag: 'gold-phone-input'},
        {tag: 'gold-zip-input'},
        {tag: 'google-analytics'},
        {tag: 'google-analytics-chart'},
        {tag: 'google-analytics-dashboard'},
        {tag: 'google-analytics-date-selector'},
        {tag: 'google-analytics-loader'},
        {tag: 'google-analytics-query'},
        {tag: 'google-analytics-view-selector'},
        {tag: 'google-apis'},
        {tag: 'google-calendar'},
        {tag: 'google-cast-sender-api'},
        {tag: 'google-castable-video', code:['<video is=\"google-castable-video\">\n  <source src=\"', 'video.mp4', '\" type=\"', 'video\/mp4', '\">\n<\/video>\n']},
        {tag: 'google-chart'},
        {tag: 'google-client-loader'},
        {tag: 'google-feeds'},
        {tag: 'google-hangout-button'},
        {tag: 'google-icons'},
        {tag: 'google-js-api'},
        {tag: 'google-legacy-loader'},
        {tag: 'google-map'},
        {tag: 'google-map-directions'},
        {tag: 'google-map-marker'},
        {tag: 'google-map-search'},
        {tag: 'google-maps-api'},
        {tag: 'google-plusone-api'},
        {tag: 'google-realtime-api'},
        {tag: 'google-recaptcha'},
        {tag: 'google-sheets'},
        {tag: 'google-signin'},
        {tag: 'google-signin-aware'},
        {tag: 'google-streetview-pano'},
        {tag: 'google-url-shortener'},
        {tag: 'google-web-components'},
        {tag: 'google-youtube'},
        {tag: 'google-youtube-api'},
        {tag: 'google-youtube-upload'},
        {tag: 'hardware-icons'},
        {tag: 'hardware-icons'},
        {tag: 'html-edit'},
        {tag: 'hydrolysis-analyzer'},
        {tag: 'identicon-avatar'},
        {tag: 'image-icons'},
        {tag: 'image-icons'},
        {tag: 'input-save'},
        {tag: 'icon-pick', code: ['<icon-pick value="{{', 'icon', '}}"></icon-pick>']},
        {tag: 'iron-ajax', code: ['<iron-ajax auto url="', 'https://api.github.com/repos/marcus7777/open-elements.org/issues', '" handle-as="', 'json', '" last-response="{{', 'data', '}}"></iron-ajax>']},
        {tag: 'iron-autogrow-textarea'},
        {tag: 'iron-button-state'},
        {tag: 'iron-checked-element-behavior'},
        {tag: 'iron-collapse'},
        {tag: 'iron-component-page'},
        {tag: 'iron-control-state'},
        {tag: 'iron-doc-property'},
        {tag: 'iron-doc-viewer'},
        {tag: 'iron-dropdown'},
        {tag: 'iron-dropdown-scroll-manager'},
        {tag: 'iron-fit-behavior'},
        {tag: 'iron-flex-layout'},
        {tag: 'iron-form'},
        {tag: 'iron-form-element-behavior'},
        {tag: 'iron-icon', code: ['<iron-icon icon="', '"></iron-icon>']},
        {tag: 'iron-icons'},
        {tag: 'iron-iconset'},
        {tag: 'iron-iconset-svg'},
        {tag: 'iron-image'},
        {tag: 'iron-image-info'},
        {tag: 'iron-input'},
        {tag: 'iron-jsonp-library'},
        {tag: 'iron-list'},
        {tag: 'iron-localstorage'},
        {tag: 'iron-media-query'},
        {tag: 'iron-menu-behavior'},
        {tag: 'iron-menubar-behavior'},
        {tag: 'iron-meta'},
        {tag: 'iron-multi-selectable'},
        {tag: 'iron-overlay-backdrop'},
        {tag: 'iron-overlay-behavior'},
        {tag: 'iron-overlay-manager'},
        {tag: 'iron-pages'},
        {tag: 'iron-range-behavior'},
        {tag: 'iron-request'},
        {tag: 'iron-resizable-behavior'},
        {tag: 'iron-selectable'},
        {tag: 'iron-selection'},
        {tag: 'iron-selector'},
        {tag: 'iron-signals'},
        {tag: 'iron-test-helpers'},
        {tag: 'iron-validatable-behavior'},
        {tag: 'iron-validator-behavior'},
        {tag: 'juicy-ace-editor'},
        {tag: 'jv-datepicker'},
        {tag: 'jv-datepicker-dialog'},
        {tag: 'kitchen-sink'},
        {tag: 'last-fm'},
        {tag: 'last-fm-artists'},
        {tag: 'last-fm-profile'},
        {tag: 'last-fm-tracks'},
        {tag: 'lazy-pages'},
        {tag: 'lunr-js', code: ['<lunr-js\n  data="[[', 'data', ']]"\n  search="{{', 'search', '}}"\n  output="{{', 'output', '}}" >\n<\/lunr-js>']},
        {tag: 'maps-icons'},
        {tag: 'maps-icons'},
        {tag: 'markdown-edit'},
        {tag: 'marked-element'},
        {tag: 'marked-import'},
        {tag: 'mediator-data',code:'<mediator-data location=\"https:\/\/mediator-data.firebaseio-demo.com\" data=\"{{data}}\"></mediator-data>'},
        {tag: 'neon-animatable'},
        {tag: 'neon-animatable-behavior'},
        {tag: 'neon-animated-pages'},
        {tag: 'neon-animation'},
        {tag: 'neon-animation-behavior'},
        {tag: 'neon-animation-runner-behavior'},
        {tag: 'neon-animations'},
        {tag: 'neon-shared-element-animatable-behavior'},
        {tag: 'neon-shared-element-animation-behavior'},
        {tag: 'notification-icons'},
        {tag: 'pair-production'},
        {tag: 'paper-audio-player'},
        {tag: 'paper-badge'},
        {tag: 'paper-button'},
        {tag: 'paper-button-behavior'},
        {tag: 'paper-card'},
        {tag: 'paper-character'},
        {tag: 'paper-checkbox'},
        {tag: 'paper-chip'},
        {tag: 'paper-dialog'},
        {tag: 'paper-dialog-behavior'},
        {tag: 'paper-dialog-scrollable'},
        {tag: 'paper-divider'},
        {tag: 'paper-drawer-panel'},
        {tag: 'paper-dropdown-menu'},
        {tag: 'paper-fab'},
        {tag: 'paper-fab-morph'},
        {tag: 'paper-fab-speed-dial'},
        {tag: 'paper-fab-transitions'},
        {tag: 'paper-filter'},
        {tag: 'paper-header-panel'},
        {tag: 'paper-icon-button'},
        {tag: 'paper-icon-item'},
        {tag: 'paper-inky-focus-behavior'},
        {tag: 'paper-input'},
        {tag: 'paper-input-addon-behavior'},
        {tag: 'paper-input-autocomplete'},
        {tag: 'paper-input-behavior'},
        {tag: 'paper-input-char-counter'},
        {tag: 'paper-input-container'},
        {tag: 'paper-input-error'},
        {tag: 'paper-item'},
        {tag: 'paper-item-body'},
        {tag: 'paper-item-shared-styles'},
        {tag: 'paper-material'},
        {tag: 'paper-menu'},
        {tag: 'paper-menu-button'},
        {tag: 'paper-menu-button-animations'},
        {tag: 'paper-people-list'},
        {tag: 'paper-progress'},
        {tag: 'paper-radio-button'},
        {tag: 'paper-radio-group'},
        {tag: 'paper-ripple'},
        {tag: 'paper-scroll-header-panel'},
        {tag: 'paper-slider'},
        {tag: 'paper-spinner'},
        {tag: 'paper-square-grow-animation'},
        {tag: 'paper-styles'},
        {tag: 'paper-styles-classes'},
        {tag: 'paper-tab'},
        {
          tag: 'paper-tabs',
          code: ['<paper-tabs>\n  <paper-tab>', 'a', '</paper-tab>\n  <paper-tab>', 'b', '</paper-tab>\n  <paper-tab>', 'c', '</paper-tab>\n</paper-tabs>']
        },
        {tag: 'paper-tabs-icons'},
        {tag: 'paper-textarea'},
        {tag: 'paper-toast'},
        {tag: 'paper-toggle-button'},
        {tag: 'paper-toolbar'},
        {tag: 'paper-tooltip'},
        {tag: 'paper-typeahead-input'},
        {tag: 'platinum-bluetooth-characteristic'},
        {tag: 'platinum-bluetooth-device'},
        {tag: 'platinum-bluetooth-elements'},
        {tag: 'platinum-https-redirect'},
        {tag: 'platinum-push-messaging'},
        {tag: 'platinum-sw-cache'},
        {tag: 'platinum-sw-elements'},
        {tag: 'platinum-sw-fetch'},
        {tag: 'platinum-sw-import-script'},
        {tag: 'platinum-sw-offline-analytics'},
        {tag: 'platinum-sw-register'},
        {tag: 'poly-color-picker'},
        {tag: 'poly-element-theme'},
        {tag: 'poly-theme-builder'},
        {tag: 'polymer-micro'},
        {tag: 'polymer-mini'},
        {tag: 'prism-highlighter'},
        {tag: 'prism-import'},
        {tag: 'promise-polyfill'},
        {tag: 'promise-polyfill-lite'},
        {tag: 'ptb-icons'},
        {tag: 'pull-to-action'},
        {tag: 'pushstate-anchor'},
        {tag: 'pushstate-anchor.csp'},
        {tag: 'qr-code'},
        {tag: 'sc-carousel'},
        {tag: 'sc-resize'},
        {tag: 'sc-swiper'},
        {tag: 'sc-thumbnail'},
        {tag: 'sc-timeago'},
        {tag: 'sc-upload'},
        {tag: 'score-element', code: ['<score-element selected="{{', 'value', '}}" start="', '0.5', '" end="', '2.0', '" step="', '0.1', '" decimals="', '1', '"></score-element>']},
        {tag: 'snap-svg'},
        {tag: 'social-icons'},
        {tag: 'sortable-import'},
        {tag: 'sortable-list'},
        {tag: 'star-rating'},
        {tag: 'sweet-material-table'},
        {tag: 'sweet-material-table-item'},
        {tag: 'sweet-material-table-styles'},
        {tag: 'test-fixture'},
        {tag: 'variables-input'},
        {tag: 'variables-list-input'},
        {tag: 'vellum-chip'},
        {tag: 'vellum-chiplist'},
        {tag: 'vellum-selectbox'},
        {tag: 'web-animations'},
        {tag: 'web-animations'},
        {tag: 'widget-import'},
        {tag: 'x-tweet'},
        {tag: 'zip-validator'}
      ]
    }
  },
  updateFilter: function () {
    var re = /<([-\w]*)$/g
    var t = this.$$('textarea')
    var start = t.selectionStart
    var end = t.selectionEnd
    if (start === end) {
      var textBefore = t.value.substring(0, start)
      var m
      if ((m = re.exec(textBefore)) !== null) {
        if (m.index === re.lastIndex) {
          re.lastIndex++
        }
        this.filter = m[1]
      } else {
        this.filter = ''
      }
    }
  },
  _getSuggestedTags: function (tags) {
    var output = []
    for (var i = 0; i < tags.length; ++i) {
      if (!tags[i].hasOwnProperty('code')) {
        tags[i].code = ['<' + tags[i].tag + '>', '', '</' + tags[i].tag + '>']
      }
  
      if (typeof tags[i].code === "string") {
        codeArray = tags[i].code.split('"')
        toggle = true

        for (var s = 0; s < codeArray.length-1; s = s + 1) {
          if (toggle) {
            codeArray[s] = codeArray[s] + '"'
          } else {
            codeArray[s] = '"' + codeArray[s] 
          }
          toggle = !toggle
        }
        tags[i].code = codeArray
      } 
        
      if (Array.isArray(tags[i].code)) {
        tags[i].move = []
        if (tags[i].code.length % 2) {
          tags[i].code.push('')
        }
        for (var m = 0; m < tags[i].code.length; m = m + 2) {
          tags[i].move.push([
            tags[i].code[m].length,
            tags[i].code[m + 1].length
          ])
        }
        tags[i].code = tags[i].code.join('')
      }
      output.push(tags[i])
    }
    return output
  },
  addTag: function () {
    var e = this.$$('select')
    var index = e.selectedIndex
    if (index !== -1) {
      var tag = e.options[index].value
      e.selectedOptions[0].selected = false
      if (tag) {
        var t = this.$$('textarea')
        var goBack = 0
        var reach = 0
        if (this.filter.length > 0) {
          goBack = (this.filter.length + 1)
        }
        if (t.value.substring(t.selectionStart, t.selectionStart + 1) === '>') {
          reach = 1
        }
        this.chrInToTab = 0

        if (e.options[index].hasOwnProperty('ontab')) {
          onTab = e.options[index].ontab
        } else {
          onTab = false
        }
        TextEvent(t, t.selectionStart - goBack, t.selectionStart + reach, tag, e.options[index].move)
      }
    }
  },
  keydown: function (e) {
    var key = keyboardMap[e.keyCode]

    if (tabStops[0]) {
      if (key.length === 1) {
        this.chrInToTab++
      }

      if (key === 'TAB' || (key === 'SPACE' && this.chrInToTab === 0)) {
        var move = 0
        var select = 0
        if (onTab) {
          onTab(this.chrInToTab)
        }
        this.chrInToTab = 0
        var fromArray = tabStops.shift()
        if (Array.isArray(fromArray)) {
          move = (fromArray[0]) * 1
          select = (fromArray[1]) * 1
        } else if ((fromArray) * 1 > 0) {
          move = fromArray
        }
        var moveTo = (e.target.selectionEnd * 1) + move
        e.target.setSelectionRange(moveTo, moveTo + select)
        e.preventDefault()
      } else if (key === 'UP' || key === 'DOWN') {
        tabStops = []
        this.chrInToTab = -1
      } else if (key === 'LEFT') {
        if ((e.target.selectionStart - e.target.selectionEnd) === 0) {
          tabStops[0][0]++
        } else {
          tabStops[0][0] = tabStops[0][0] + (e.target.selectionEnd - e.target.selectionStart )
        }
      } else if (key === 'RIGHT') {
        if ((e.target.selectionStart - e.target.selectionEnd) === 0) {
          tabStops[0][0]--
        }
      }
    } else {
      this.chrInToTab = null
    }
  },
  takekey: function (e) {
    this.debounce('updateFilter', this.updateFilter, 500)
  }
})
</script>
