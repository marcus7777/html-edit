<link rel="import" href="../polymer/polymer.html">
<!--
`<html-edit>` help you edit html.
@demo demo.html
-->

<dom-module id="html-edit">
  <template>
    <div>
      <h3>{{label}}</h3>
      <textarea style="width:100%" on-blur="updateFilter" onkeyup="takekeyup(this)" label="{{label}}" value="{{value::change}}"></textarea>
      <select on-blur="addTag" multiple>
        <template is="dom-repeat" items="{{suggestedTags}}">
          <option value="{{item.code}}" title="{{item.move}}">{{item.tag}}</option>
        </template>
      </select>
    </div>
  </template>
</dom-module>
<script>
  function TextEvent(editor, start, end, text, move) {
    if (start === end) {
      start = editor.selectionStart;
      end = editor.selectionEnd;
    }
    var e = document.createEvent('TextEvent');
    e.initTextEvent('textInput', true, true, null, text, 9, "en-US");
    editor.focus();
    editor.setSelectionRange(start, end);
    editor.dispatchEvent(e);
    var moveTo = (start*1) + move
    editor.setSelectionRange(moveTo, moveTo);
  }
  function takekeyup (e) {
    if (!e.lastValue) {
      if (!e.value) {
        e.lastValue = "";
      } else {
        e.lastValue = e.value;
      }
    }
    var last = e.lastValue, current = e.value;
    // Added chars
    if (current.length > last.length) {
      var start = e.selectionStart, added = current.substr(start - 1, 1);
      if (added == "<") {
        TextEvent(e, start - 1, start, '<>', 1);
      } else if (added == '"') {
        TextEvent(e, start - 1, start, '""', 1);   
      } else if (added == "'") {
        TextEvent(e, start - 1, start, "''", 1);
      } else if (added == '{') {
        TextEvent(e, start - 1, start, '{}', 1);
      } else if (added == '[') {
        TextEvent(e, start - 1, start, '[]', 1);
      }
    }
    e.lastValue = e.value;
  };
  Polymer({
    is: "html-edit",
    properties: {
      value: {type:String,notify:true},
      label: String,
      suggestedTags: {computed:"_getSuggestedTags(tags,filter)"},
      filter:{value:""},
      tags: {
        value:[
          {code:'<template is="dom-if" if="{{}}">\n  \n</template>',tag:"dom-if",move:28},
          {code:'<template is="dom-repeat" items="{{}}">\n  \n</template>',tag:"dom-repeat",move:35},
          {code:"<paper-input label='label' value='{{}}'></paper-input>",tag:"paper-input",move:36},
          {code:"<h1></h1>\n",tag:"h1",move:4},
          {code:"<h2></h2>\n",tag:"h2",move:4},
          {code:"<h3></h3>\n",tag:"h3",move:4},
          {code:"<h4></h4>\n",tag:"h4",move:4},
          {code:"<h5></h5>\n",tag:"h5",move:4},
          {code:"<h6></h6>\n",tag:"h6",move:4},
          {code:"<p></p>\n",tag:"p",move:3},
          {code:"<i></i>",tag:"i",move:3},
          {code:'<a href=""></a>',tag:"a",move:9},
          {code:"\n<ul>\n  <li></li>\n</ul>\n",tag:"ul",move:11},
          {code:"<blockquote></blockquote>",tag:"blockquote",move:12},
          {code:"\n<hr />\n",tag:"hr",move:8},
          {code:'<img src="" />\n',tag:"img",move:10},
          {code:"<div>\n</div>\n",tag:"div",move:7},
          {tag:"account-summaries-import"},
{tag:"accounting-element"},
{tag:"accounting-import"},
{tag:"all-imports"},
{tag:"animation-tag"},
{tag:"app-globals"},
{tag:"app-router"},
{tag:"av-icons"},
{tag:"blockies-import"},
{tag:"iron-a11y-announcer"},
{tag:"iron-a11y-keys-behavior"},
{tag:"iron-a11y-keys"},
{tag:"commits-element"},
{tag:"commonmark-editor"},
{tag:"commonmark-editor-import"},
{tag:"communication-icons"},
{tag:"communication-icons"},
{tag:"cosmoz-page-route"},
{tag:"cosmoz-page-router"},
{tag:"date-input"},
{tag:"date-validator"},
{tag:"default-theme"},
{tag:"demo-element"},
{tag:"demo-pages"},
{tag:"detect-import-node-bug"},
{tag:"device-icons"},
{tag:"device-icons"},
{tag:"dom-else"},
{tag:"edit-in-jsbin"},
{tag:"editor-icons"},
{tag:"editor-icons"},
{tag:"element-load"},
{tag:"excess-route"},
{tag:"excess-route-manager"},
{tag:"excess-router"},
{tag:"excess-router-config"},
{tag:"firebase-auth"},
{tag:"firebase-collection"},
{tag:"firebase-document"},
{tag:"firebase-query-behavior"},
{tag:"flip-clock"},
{tag:"function-list-input"},
{tag:"geo-hash-data"},
{tag:"geohash-js"},
{tag:"get-hash"},
{tag:"github-issues"},
{tag:"gold-cc-cvc-input"},
{tag:"gold-cc-expiration-input"},
{tag:"gold-cc-input"},
{tag:"gold-email-input"},
{tag:"gold-phone-input"},
{tag:"gold-zip-input"},
{tag:"google-analytics"},
{tag:"google-analytics-chart"},
{tag:"google-analytics-dashboard"},
{tag:"google-analytics-date-selector"},
{tag:"google-analytics-loader"},
{tag:"google-analytics-query"},
{tag:"google-analytics-view-selector"},
{tag:"google-apis"},
{tag:"google-calendar"},
{tag:"google-cast-sender-api"},
{tag:"google-castable-video"},
{tag:"google-chart"},
{tag:"google-client-loader"},
{tag:"google-feeds"},
{tag:"google-hangout-button"},
{tag:"google-icons"},
{tag:"google-js-api"},
{tag:"google-legacy-loader"},
{tag:"google-map"},
{tag:"google-map-directions"},
{tag:"google-map-marker"},
{tag:"google-map-search"},
{tag:"google-maps-api"},
{tag:"google-plusone-api"},
{tag:"google-realtime-api"},
{tag:"google-recaptcha"},
{tag:"google-sheets"},
{tag:"google-signin"},
{tag:"google-signin-aware"},
{tag:"google-streetview-pano"},
{tag:"google-url-shortener"},
{tag:"google-web-components"},
{tag:"google-youtube"},
{tag:"google-youtube-api"},
{tag:"google-youtube-upload"},
{tag:"hardware-icons"},
{tag:"hardware-icons"},
{tag:"html-edit"},
{tag:"hydrolysis-analyzer"},
{tag:"identicon-avatar"},
{tag:"image-icons"},
{tag:"image-icons"},
{tag:"input-save"},
{tag:"iron-ajax"},
{tag:"iron-autogrow-textarea"},
{tag:"iron-button-state"},
{tag:"iron-checked-element-behavior"},
{tag:"iron-collapse"},
{tag:"iron-component-page"},
{tag:"iron-control-state"},
{tag:"iron-doc-property"},
{tag:"iron-doc-viewer"},
{tag:"iron-dropdown"},
{tag:"iron-dropdown-scroll-manager"},
{tag:"iron-fit-behavior"},
{tag:"iron-flex-layout"},
{tag:"iron-form"},
{tag:"iron-form-element-behavior"},
{tag:"iron-icon"},
{tag:"iron-icons"},
{tag:"iron-icons"},
{tag:"iron-iconset"},
{tag:"iron-iconset-svg"},
{tag:"iron-image"},
{tag:"iron-image-info"},
{tag:"iron-input"},
{tag:"iron-jsonp-library"},
{tag:"iron-list"},
{tag:"iron-localstorage"},
{tag:"iron-media-query"},
{tag:"iron-menu-behavior"},
{tag:"iron-menubar-behavior"},
{tag:"iron-meta"},
{tag:"iron-multi-selectable"},
{tag:"iron-overlay-backdrop"},
{tag:"iron-overlay-behavior"},
{tag:"iron-overlay-manager"},
{tag:"iron-pages"},
{tag:"iron-range-behavior"},
{tag:"iron-request"},
{tag:"iron-resizable-behavior"},
{tag:"iron-selectable"},
{tag:"iron-selection"},
{tag:"iron-selector"},
{tag:"iron-signals"},
{tag:"iron-test-helpers"},
{tag:"iron-validatable-behavior"},
{tag:"iron-validator-behavior"},
{tag:"juicy-ace-editor"},
{tag:"jv-datepicker"},
{tag:"jv-datepicker-dialog"},
{tag:"kitchen-sink"},
{tag:"last-fm"},
{tag:"last-fm-artists"},
{tag:"last-fm-profile"},
{tag:"last-fm-tracks"},
{tag:"lazy-pages"},
{tag:"lunr-js"},
{tag:"maps-icons"},
{tag:"maps-icons"},
{tag:"markdown-edit"},
{tag:"marked-element"},
{tag:"marked-import"},
{tag:"mediator-data"},
{tag:"neon-animatable"},
{tag:"neon-animatable-behavior"},
{tag:"neon-animated-pages"},
{tag:"neon-animation"},
{tag:"neon-animation-behavior"},
{tag:"neon-animation-runner-behavior"},
{tag:"neon-animations"},
{tag:"neon-shared-element-animatable-behavior"},
{tag:"neon-shared-element-animation-behavior"},
{tag:"notification-icons"},
{tag:"pair-production"},
{tag:"paper-audio-player"},
{tag:"paper-badge"},
{tag:"paper-button"},
{tag:"paper-button-behavior"},
{tag:"paper-card"},
{tag:"paper-character"},
{tag:"paper-checkbox"},
{tag:"paper-chip"},
{tag:"paper-dialog"},
{tag:"paper-dialog-behavior"},
{tag:"paper-dialog-scrollable"},
{tag:"paper-divider"},
{tag:"paper-drawer-panel"},
{tag:"paper-dropdown-menu"},
{tag:"paper-fab"},
{tag:"paper-fab-morph"},
{tag:"paper-fab-speed-dial"},
{tag:"paper-fab-transitions"},
{tag:"paper-filter"},
{tag:"paper-header-panel"},
{tag:"paper-icon-button"},
{tag:"paper-icon-item"},
{tag:"paper-inky-focus-behavior"},
{tag:"paper-input"},
{tag:"paper-input-addon-behavior"},
{tag:"paper-input-autocomplete"},
{tag:"paper-input-behavior"},
{tag:"paper-input-char-counter"},
{tag:"paper-input-container"},
{tag:"paper-input-error"},
{tag:"paper-item"},
{tag:"paper-item-body"},
{tag:"paper-item-shared-styles"},
{tag:"paper-material"},
{tag:"paper-menu"},
{tag:"paper-menu-button"},
{tag:"paper-menu-button-animations"},
{tag:"paper-people-list"},
{tag:"paper-progress"},
{tag:"paper-radio-button"},
{tag:"paper-radio-group"},
{tag:"paper-ripple"},
{tag:"paper-scroll-header-panel"},
{tag:"paper-slider"},
{tag:"paper-spinner"},
{tag:"paper-square-grow-animation"},
{tag:"paper-styles"},
{tag:"paper-styles-classes"},
{tag:"paper-tab"},
{tag:"paper-tabs"},
{tag:"paper-tabs-icons"},
{tag:"paper-textarea"},
{tag:"paper-toast"},
{tag:"paper-toggle-button"},
{tag:"paper-toolbar"},
{tag:"paper-tooltip"},
{tag:"paper-typeahead-input"},
{tag:"platinum-bluetooth-characteristic"},
{tag:"platinum-bluetooth-device"},
{tag:"platinum-bluetooth-elements"},
{tag:"platinum-https-redirect"},
{tag:"platinum-push-messaging"},
{tag:"platinum-sw-cache"},
{tag:"platinum-sw-elements"},
{tag:"platinum-sw-fetch"},
{tag:"platinum-sw-import-script"},
{tag:"platinum-sw-offline-analytics"},
{tag:"platinum-sw-register"},
{tag:"poly-color-picker"},
{tag:"poly-element-theme"},
{tag:"poly-theme-builder"},
{tag:"polymer-micro"},
{tag:"polymer-mini"},
{tag:"prism-highlighter"},
{tag:"prism-import"},
{tag:"promise-polyfill"},
{tag:"promise-polyfill-lite"},
{tag:"ptb-icons"},
{tag:"pull-to-action"},
{tag:"pushstate-anchor"},
{tag:"pushstate-anchor.csp"},
{tag:"qr-code"},
{tag:"sc-carousel"},
{tag:"sc-resize"},
{tag:"sc-swiper"},
{tag:"sc-thumbnail"},
{tag:"sc-timeago"},
{tag:"sc-upload"},
{tag:"snap-svg"},
{tag:"social-icons"},
{tag:"social-icons"},
{tag:"sortable-import"},
{tag:"sortable-list"},
{tag:"star-rating"},
{tag:"sweet-material-table"},
{tag:"sweet-material-table-item"},
{tag:"sweet-material-table-styles"},
{tag:"test-fixture"},
{tag:"variables-input"},
{tag:"variables-list-input"},
{tag:"vellum-chip"},
{tag:"vellum-chiplist"},
{tag:"vellum-selectbox"},
{tag:"web-animations"},
{tag:"web-animations"},
{tag:"widget-import"},
{tag:"x-tweet"},
{tag:"zip-validator"}
        ]
      }
    },
    updateFilter : function () {
      var re = /<([-\w]*)$/g;
      var t = this.$$('textarea');
      var start = t.selectionStart;
      var end = t.selectionEnd;
      if (start === end) {
        var textBefore = t.value.substring(0, start);
        var m;
        if ((m = re.exec(textBefore)) !== null) {
          if (m.index === re.lastIndex) {
            re.lastIndex++;
          }
          this.filter = m[1];
        } else {
          this.filter = "";
        }
      }
    },
    _getSuggestedTags: function(tags,filter) {
      function fillOut(tags) {
        var output = [];
        for (var i= 0; i < tags.length; ++i) {
          if (!tags[i].hasOwnProperty("code")) {
            tags[i].code = "<" + tags[i].tag + "></" + tags[i].tag + ">";
            tags[i].move = ("<" + tags[i].tag + ">").length;
          }
          output.push(tags[i])
        }
        return output;
      }
      if (filter != "") {
        return tags.filter(function(item) {
          return item.tag.indexOf(filter) !== -1;
        });
      } else {        
        return fillOut(tags);
      }
    },
    addTag: function() {
      var e = this.$$('select');
      var index = e.selectedIndex;
      var tag = e.options[index].value;
      e.selectedOptions[0].selected = false;
      if (tag) {
        var t = this.$$('textarea');
        var goBack = 0;
        var reach = 0;
        if (this.filter.length > 0){
          goBack = (this.filter.length +1);
        }
        if ( t.value.substring(t.selectionStart,t.selectionStart+1) == ">"){
          reach = 1;
        }
        TextEvent(t, t.selectionStart-goBack, t.selectionStart+reach, tag, e.options[index].title*1);
      }
    }
  });
</script>
